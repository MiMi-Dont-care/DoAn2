<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Báo cáo tài chính - Kế toán | Mì Cay Đức Hiệu</title>

    <!-- CSS hệ thống -->
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/grid.css" />
    <link rel="stylesheet" href="../css/color.css" />
    <link rel="stylesheet" href="../css/typography.css" />
    <link rel="stylesheet" href="../css/button.css" />
    <link rel="stylesheet" href="../css/flex.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <link rel="stylesheet" href="../css/common.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .filter-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: .5rem;
        }

        .year-filter {
            padding: .5rem .75rem;
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            background: #fff;
        }

        canvas {
            width: 100%;
            max-width: 1100px;
            height: 360px;
            display: block;
            margin: auto;
        }

        @media print {

            .admin-header,
            .admin-sidebar,
            .admin-footer,
            .filter-bar,
            #btnExport {
                display: none !important;
            }

            body {
                background: #fff;
                padding: 40px;
                font-family: "Times New Roman", Times, serif;
                color: #000;
            }

            main.admin-main {
                margin: 0;
                padding: 0;
            }

            table {
                border-collapse: collapse;
                width: 100%;
            }

            th,
            td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
            }

            .status {
                font-weight: bold;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="logo">Mì Cay Đức Hiệu - Accounting</div>

        <div class="user-menu" id="userMenu">
            <i class="fas fa-user-circle"></i>
            <span>Accounting</span>

            <div class="user-dropdown">
                <a href="profile.html"><i class="fas fa-id-card"></i> Trang cá nhân</a>
                <a href="change-password.html"><i class="fas fa-key"></i> Đổi mật khẩu</a>
                <a href="#" class="logout"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
            </div>
        </div>
    </header>


    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <ul>
            <li><a href="dashboard.html" style="color:white;text-decoration:none;"><i class="fas fa-chart-line"></i>
                    Dashboard</a></li>
            <li><a href="franchise-fee.html" style="color:white;text-decoration:none;"><i class="fas fa-receipt"></i>
                    Hóa đơn phí franchise</a></li>
            <li class="active"><a href="report.html" style="color:white;text-decoration:none;"><i
                        class="fas fa-chart-pie"></i> Báo cáo
                    tài chính</a></li>
            <li><a href="report-store.html" style="color:white;text-decoration:none;"><i class="fas fa-store"></i> Báo
                    cáo theo cửa hàng</a></li>
            <li><a href="export.html" style="color:white;text-decoration:none;"><i class="fas fa-file-export"></i> Xuất
                    báo cáo</a></li>
        </ul>
    </aside>

    <!-- Main -->
    <main class="admin-main">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="fs-2 fw-bold">Báo cáo tài chính tổng hợp</h1>
            <button id="btnExport" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
        </div>

        <!-- Bộ lọc năm -->
        <div class="filter-bar mb-3">
            <label for="yearFilter" class="fw-bold">Năm:</label>
            <select id="yearFilter" class="year-filter">
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
            </select>
        </div>

        <!-- Biểu đồ doanh thu -->
        <section class="table-box mb-4">
            <h2 class="fs-4 fw-bold mb-3">Doanh thu theo tháng (tỷ VND)</h2>
            <canvas id="revenueChart"></canvas>
        </section>

        <!-- Biểu đồ phí franchise -->
        <section class="table-box mb-4">
            <h2 class="fs-4 fw-bold mb-3">Phí franchise theo tháng (triệu VND)</h2>
            <canvas id="feeChart"></canvas>
        </section>

        <!-- Bảng dữ liệu -->
        <section id="printArea">
            <div id="printHeader" class="text-center mb-3" style="display:none;">
                <h2 style="text-transform:uppercase;">BÁO CÁO TÀI CHÍNH NĂM <span id="yearTitle">2025</span></h2>
                <p>Ngày xuất: <span id="printDate"></span></p>
                <hr style="width:200px;margin:10px auto;">
            </div>

            <h2 class="fs-4 fw-bold mb-2">Chi tiết theo tháng</h2>
            <table class="report__table store-table">
                <thead>
                    <tr>
                        <th>Tháng</th>
                        <th>Doanh thu (tỷ VND)</th>
                        <th>Phí franchise (triệu VND)</th>
                        <th>Tỷ lệ nộp đúng hạn (%)</th>
                        <th>Lợi nhuận ước tính (triệu VND)</th>
                    </tr>
                </thead>
                <tbody id="financeTableBody"></tbody>
            </table>
        </section>
    </main>

    <!-- Footer -->
    <footer class="admin-footer">© 2025 Mì Cay Đức Hiệu - Accounting System</footer>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const revenueCtx = document.getElementById("revenueChart");
            const feeCtx = document.getElementById("feeChart");
            const yearFilter = document.getElementById("yearFilter");
            const tableBody = document.getElementById("financeTableBody");
            const btnExport = document.getElementById("btnExport");
            const printHeader = document.getElementById("printHeader");
            const printDate = document.getElementById("printDate");
            const yearTitle = document.getElementById("yearTitle");

            // Dummy data
            const DB = {
                "2025": [
                    { m: "T1", rev: 2.5, fee: 120, rate: 95 },
                    { m: "T2", rev: 2.8, fee: 135, rate: 92 },
                    { m: "T3", rev: 3.0, fee: 145, rate: 90 },
                    { m: "T4", rev: 3.3, fee: 150, rate: 96 },
                    { m: "T5", rev: 3.6, fee: 155, rate: 94 },
                    { m: "T6", rev: 3.8, fee: 160, rate: 97 },
                    { m: "T7", rev: 4.0, fee: 165, rate: 98 },
                    { m: "T8", rev: 4.2, fee: 170, rate: 93 },
                    { m: "T9", rev: 4.3, fee: 175, rate: 95 },
                    { m: "T10", rev: 4.5, fee: 180, rate: 96 },
                    { m: "T11", rev: 4.7, fee: 185, rate: 96 },
                    { m: "T12", rev: 4.9, fee: 190, rate: 97 }
                ],
                "2024": [
                    { m: "T1", rev: 2.0, fee: 100, rate: 90 },
                    { m: "T2", rev: 2.2, fee: 105, rate: 88 },
                    { m: "T3", rev: 2.4, fee: 110, rate: 85 },
                    { m: "T4", rev: 2.6, fee: 115, rate: 89 },
                    { m: "T5", rev: 2.9, fee: 120, rate: 91 },
                    { m: "T6", rev: 3.0, fee: 125, rate: 92 },
                    { m: "T7", rev: 3.2, fee: 130, rate: 93 },
                    { m: "T8", rev: 3.3, fee: 135, rate: 94 },
                    { m: "T9", rev: 3.4, fee: 140, rate: 90 },
                    { m: "T10", rev: 3.5, fee: 145, rate: 91 },
                    { m: "T11", rev: 3.6, fee: 148, rate: 92 },
                    { m: "T12", rev: 3.7, fee: 150, rate: 92 }
                ]
            };

            let revenueChart, feeChart;

            function renderCharts(year) {
                const rows = DB[year];
                const labels = rows.map(r => r.m);
                const rev = rows.map(r => r.rev);
                const fees = rows.map(r => r.fee);

                if (revenueChart) revenueChart.destroy();
                if (feeChart) feeChart.destroy();

                // Chart 1: Revenue
                revenueChart = new Chart(revenueCtx, {
                    type: "line",
                    data: {
                        labels,
                        datasets: [{
                            label: "Doanh thu (tỷ VND)",
                            data: rev,
                            borderColor: "#0d6efd",
                            backgroundColor: "rgba(13,110,253,0.15)",
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: "bottom" } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Chart 2: Franchise fee
                feeChart = new Chart(feeCtx, {
                    type: "bar",
                    data: {
                        labels,
                        datasets: [{
                            label: "Phí franchise (triệu VND)",
                            data: fees,
                            backgroundColor: "rgba(25,135,84,0.6)",
                            borderColor: "#198754",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: "bottom" } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            function renderTable(year) {
                const rows = DB[year];
                tableBody.innerHTML = "";
                rows.forEach(r => {
                    const profit = Math.max(0, Math.round(r.rev * 1000 - r.fee));
                    tableBody.insertAdjacentHTML(
                        "beforeend",
                        `<tr>
              <td>${r.m}</td>
              <td>${r.rev.toFixed(1)}</td>
              <td>${r.fee.toLocaleString("vi-VN")}</td>
              <td>${r.rate}%</td>
              <td>${profit.toLocaleString("vi-VN")}</td>
            </tr>`
                    );
                });
            }

            // Lọc theo năm
            yearFilter.addEventListener("change", function () {
                const y = this.value;
                yearTitle.textContent = y;
                renderCharts(y);
                renderTable(y);
            });

            // Xuất PDF
            btnExport.addEventListener("click", function () {
                const today = new Date();
                const formatted = today.toLocaleDateString("vi-VN", {
                    day: "2-digit", month: "2-digit", year: "numeric",
                    hour: "2-digit", minute: "2-digit"
                });
                printDate.textContent = formatted;
                printHeader.style.display = "block";
                window.print();
                setTimeout(() => (printHeader.style.display = "none"), 300);
            });

            // Khởi tạo
            const initYear = yearFilter.value;
            yearTitle.textContent = initYear;
            renderCharts(initYear);
            renderTable(initYear);
        });
    </script>
</body>

</html>